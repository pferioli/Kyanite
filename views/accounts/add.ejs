<%- include ("../partials/header") %>

<main class="site-content">
    <div class="container" style="margin-top: 50px;">
        <form class="col s12" method="post" action='/accounts/new/<%=data.client.id%>'>
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Crear una nueva cuenta de cliente</span>
                    <div class="row" style="margin-top: 20px;">
                        <div class="input-field col s12">
                            <i class="material-icons prefix">home</i>
                            <input id="client" name="client" type="text" value="<%=data.client.name%> [<%=data.client.internalCode%>]" disabled />
                            <label for="name">Nombre del Barrio</label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-field col s6">
                            <select id="accountTypeSelect">
                                <option value="" disabled selected>Seleccione el tipo de cuenta</option>
                                <% for(var i=0; i < data.accountTypes.length; i++) { %>
                                <option value="<%=data.accountTypes[i].id%>">[<%=data.accountTypes[i].account%>] <%=data.accountTypes[i].description%></option>
                                <% } %>
                            </select>
                            <label>Tipo de Cuenta</label>
                            <input type="hidden" name="accountTypeId" id="accountTypeId" />
                        </div>
                        <div class="input-field col s6">
                            <select id="bankSelect" disabled>
                                <option value="0" disabled selected>Seleccione un banco</option>
                                <% for(var i=0; i < data.banks.length; i++) { %>
                                <option value="<%=data.banks[i].id%>"><%= data.banks[i].name%> [<%=data.banks[i].code%>]</option>
                                <% } %>
                            </select>
                            <label>Banco</label>
                            <input type="hidden" name="bankId" id="bank" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-field col s3">
                            <i class="material-icons prefix">account_balance</i>
                            <input id="cbu" name="cbu" type="text" class="validate" minlength="22" maxlength="22" patern="^[0-9]{22}" required disabled onfocusout="validateCBU(this)" />
                            <label for="cbu">C.B.U.</label><span class="helper-text" data-error="formato inválido" data-success="correcto">ingrese los 22 digitos sin espacios</span>
                        </div>
                        <div class="input-field col s3">
                            <input id="accountNumber" name="accountNumber" type="text" disabled />
                            <label for="accountNumber">Cuenta</label>
                        </div>
                        <div class="input-field col s3">
                            <input id="accountAlias" name="accountAlias" type="text" minlength="6" maxlength="20" disabled />
                            <label for="accountAlias">Alias</label>
                        </div>
                        <div class="input-field col s3">
                            <input id="bankBranch" name="bankBranch" type="text" class="validate" disabled />
                            <label for="bankBranch">Sucursal</label>
                        </div>
                    </div>
                    <div class="row">
                        <p class="center-align grey-text" style="font-size: small;">estos campos se habilitan automáticamente al seleccionar una caja de ahorro o una cuenta corriente que requieren datos bancarios</p>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <textarea id="comments" name="comments" class="materialize-textarea" required></textarea>
                            <label for="comments">Comentarios</label>
                        </div>
                    </div>

                    <div class="card-action right-align">
                        <button id="add_button" type='submit' class="waves-effect waves-light btn green" style="margin-right: 10px;"><i class="material-icons right">save</i>Guardar</button>
                        <button action="action" onclick="window.history.go(-1); return false;" type="submit" value="Cancel" class="waves-effect waves-light btn red" style="margin-left: 20px;"><i class="material-icons right">cancel</i>Volver</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

</main>

<%- include ("../partials/footer") %>

<script>

    var bankCode = "";

    document.addEventListener("DOMContentLoaded", function () {
        var elems = document.querySelectorAll("select");
        var instances = M.FormSelect.init(elems, {});
        M.CharacterCounter.init(document.getElementById("comments"));

        const accountTypeSelect = document.getElementById("accountTypeSelect");
        accountTypeSelect.addEventListener('change', (event) => {

            const accountType = event.target.options[event.target.selectedIndex].text;

            let bankSelect = document.getElementById("bankSelect");

            let accountNumber = document.getElementById("accountNumber");
            let accountAlias = document.getElementById("accountAlias");
            let bankBranch = document.getElementById("bankBranch");
            let cbu = document.getElementById("cbu");

            if ((accountType.includes('[CC$]')) || (accountType.includes('[CA$]')) || (accountType.includes('[CCU$]')) || (accountType.includes('[CAU$]'))) {
                // accountNumber.disabled = false;
                // accountAlias.disabled = false;
                // bankBranch.disabled = false;
                // cbu.disabled = false;
                bankSelect.disabled = false;
            } else {
                accountNumber.value = ""; accountNumber.classList.remove("valid"); accountNumber.disabled = true;
                accountAlias.value = ""; accountAlias.classList.remove("valid"); accountAlias.disabled = true;
                bankBranch.value = ""; bankBranch.classList.remove("valid"); bankBranch.disabled = true;
                cbu.value = ""; cbu.classList.remove("valid"); cbu.disabled = true;
                bankSelect.selectedIndex = "0";
                bankSelect.disabled = true;
            };
            M.FormSelect.init(bankSelect, {});
            M.updateTextFields();
        });

        const bankSelect = document.getElementById("bankSelect");
        bankSelect.addEventListener('change', (event) => {

            const bank = event.target.options[event.target.selectedIndex].text;

            bankCode = bank.substr(bank.indexOf("["));

            let cbu = document.getElementById("cbu");
            let accountNumber = document.getElementById("accountNumber");
            let accountAlias = document.getElementById("accountAlias");
            let bankBranch = document.getElementById("bankBranch");

            cbu.value = ""; cbu.disabled = false;
            accountNumber.value = ""; accountNumber.disabled = false;
            accountAlias.value = ""; accountAlias.disabled = false;
            bankBranch.value = ""; bankBranch.disabled = false;

            M.updateTextFields(); cbu.focus();
        });
    });

    function validateCBU(e) {
        if (e.value === '') return;
        const isCBU = validarCBU(e.value);
        if (isCBU === false) {
            alert('la CBU ingresada es incorrecta');
        } else {
            if (`[${e.value}]` != bankCode) { alert('la CBU ingresada no pertenece al banco seleccionado, debe comenzar con ' + bankCode); };
        }
    };

</script>

<script type="text/javascript" src="/javascripts/validateCBU.js"></script>